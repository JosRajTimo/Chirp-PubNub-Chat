<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.23.0.js"></script>
<script src="chirp-connect.js"></script>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/png" href="icon.png">
    <title>PubNub Chirp Chat</title>
  </head>

  <style>
    .center {
        position: absolute;
        right: 0;
        left: 0;
        margin: auto;
    }

    .msg-group {
    	position: absolute;
        max-width: 720px;
        height: 92%;
        overflow-y: scroll;
    }

    .card {
        padding: 8px 0 8px 0;
    }

    .input-group {
    	position: absolute;
        height: 8%;
    	bottom: 0;
    }

    textarea {
        resize: none;
    }
  </style>

  <body>
    <div>
        <div class="modal" id="welcomeModal" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Waiting for chirp...</h5>
              </div>
              <div class="modal-body">
                <p>
                Allow access to your microphone to listen for chirps. If a chirp is detected you will be connected to the chat. Your microphone is not recorded or streamed to any server.</p>
                <p>Create a chat to start your own channel and broadcast a chirp for others to join you.</p>
              </div>
              <div class="modal-footer">
                <button id="host-button" type="button" class="btn btn-primary">Create Chat</button>
              </div>
            </div>
          </div>
        </div>
        <div class="msg-group center">                 
        </div>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <button id="chirp-button" class="btn btn-secondary" type="button">Chirp</button>
            </div>
            <textarea id="input-box" class="form-control" rows="1"></textarea>
            <div class="input-group-append">
                <button id="send-button" class="btn btn-primary" type="button">Send Message</button>
            </div>
        </div>
    </div>

    <script>
        $('#welcomeModal').modal('show');
        const { Chirp, toAscii } = ChirpConnectSDK
        const key = '847AE335BabB1EFDB9Ca0507c'
        let sdk
        var channel = "";

        Chirp({
            key: '847AE335BabB1EFDB9Ca0507c',
            onReceived: data => {
                if (data.length > 0 && channel == "") {
                    console.log(toAscii(data))
                    channel = toAscii(data);
                    StartChat();
                }   
            }
        })
        .then(_sdk => {
            sdk = _sdk
        })
        .catch(console.warn)
        class chat_control {
            constructor() {
                this.msg_list = $('.msg-group');
            }
            publishMessage(name, msg) {
                this.msg_list.append(this.msg_html(name, msg, 'right'));
                this.scroll_to_bottom(); 
            }
            receiveMessage(name, msg) {
                this.msg_list.append(this.msg_html(name, msg, 'left'));
                this.scroll_to_bottom(); 
            }
            msg_html(name, msg, side) {
                var msg_temple = `
                    <div class="card">
                         <div class="card-body">
                             <h6 class="card-subtitle mb-2 text-muted text-${side}">${name}</h6>
                             <p class="card-text float-${side}">${msg}</p>
                         </div>
                    </div>
                    `;
                return msg_temple;
            }
            scroll_to_bottom() {
                this.msg_list.scrollTop(this.msg_list[0].scrollHeight);
            }
        }
        var chat = new chat_control();
        send_button = $('#send-button')
        input_box = $('#input-box')
        host_button = $('#host-button')
        chirp_button = $('#chirp-button')
        function StartChat() {
            host_button.off('click', StartChat.bind());
            pubnub = new PubNub({
                publishKey : 'demo',
                subscribeKey : 'demo'
            })
            if (channel == "") {
                channel = pubnub.getUUID().slice(-10);
            }  
            pubnub.addListener({
                status: function(statusEvent) {
                    if (statusEvent.category === "PNConnectedCategory") {
                        $('#welcomeModal').modal('hide');
                        chat.receiveMessage('Welcome', "You're connected to the chat! Press 'Chirp' to share your chat with a nearby device.");
                    }
                },
                message: function(msg) {
                    if (msg.publisher == pubnub.getUUID()) {
                        chat.publishMessage('You', msg.message);
                    } else {
                        chat.receiveMessage('Guest', msg.message);
                    }
                },
            })      
            pubnub.subscribe({
                channels: [channel] 
            });
            function handleMessage(msg) {
                msg = msg.trim()
                msg = msg.replace(/(?:\r\n|\r|\n)/g, '<br>')
                return msg
            }
            function publishMessage() {
                msg = handleMessage(input_box.val());
                if (msg != '') {
                    var publishConfig = {
                        channel: channel,
                        message: msg
                    }
                    pubnub.publish(publishConfig, function(status, response) {
                        //console.log(status, response);
                    })
                    input_box.val('');
                }
            }
            function chripSend() {
                const payload = new TextEncoder('utf-8').encode(channel);
                sdk.send(payload);
            }
            input_box.keyup(function (e) {
                if(e.keyCode == 13 && !e.shiftKey) {
                    publishMessage();
                }
                if (e.keyCode === 27) {
                    input_box.blur();
                }
            });
            send_button.on('click', publishMessage.bind());
            chirp_button.on('click', chripSend.bind());
        };
        host_button.on('click', StartChat.bind());
    </script>
  </body>
</html>